<div class="historique-page container">
    <div class="page-header">
        <h1>üìã Historique des R√©servations</h1>
        <p class="subtitle">Consultez et g√©rez toutes vos r√©servations</p>
    </div>

    <!-- Filters -->
    <div class="filters-bar glass-panel">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" [(ngModel)]="searchQuery" (ngModelChange)="applyFilters()"
                placeholder="Rechercher par client ou tour...">
        </div>

        <div class="filter-group">
            <select [(ngModel)]="statusFilter" (change)="applyFilters()" class="filter-select">
                <option value="all">Tous les statuts</option>
                <option value="pending">En attente</option>
                <option value="confirmed">Confirm√©e</option>
                <option value="rejected">Rejet√©e</option>
                <option value="completed">Termin√©e</option>
                <option value="cancelled">Annul√©e</option>
            </select>

            <select [(ngModel)]="tourTypeFilter" (change)="applyFilters()" class="filter-select">
                <option value="all">Tous les tours</option>
                <option *ngFor="let tourType of allTourTypes" [value]="tourType">{{ tourType }}</option>
            </select>

            <select [(ngModel)]="sortBy" (change)="applyFilters()" class="filter-select">
                <option value="date">Trier par date</option>
                <option value="amount">Trier par montant</option>
            </select>

            <button class="btn-icon" (click)="sortOrder = sortOrder === 'asc' ? 'desc' : 'asc'; applyFilters()"
                title="Inverser l'ordre">
                <span *ngIf="sortOrder === 'asc'">‚Üë</span>
                <span *ngIf="sortOrder === 'desc'">‚Üì</span>
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="loading">
        <div class="spinner"></div>
        <p>Chargement des r√©servations...</p>
    </div>

    <!-- Table -->
    <div class="table-container glass-panel" *ngIf="!loading">
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Date</th>
                        <th>Groupe</th>
                        <th>Type de Tour</th>
                        <th>Montant</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let res of paginatedReservations" class="table-row">
                        <td class="client-name">
                            <div class="client-info">
                                <span class="name">{{ res.contactInfo.firstName }} {{ res.contactInfo.lastName }}</span>
                                <span class="email">{{ res.contactInfo.email }}</span>
                            </div>
                        </td>
                        <td class="date-cell">
                            <div class="date-info">
                                <span class="date">{{ res.checkInDate | date:'dd/MM/yyyy' }}</span>
                                <span class="time">{{ res.checkInDate | date:'shortTime' }}</span>
                            </div>
                        </td>
                        <td class="group-cell">
                            <div class="group-info">
                                <span class="adults">üë• {{ res.adults }} adultes</span>
                                <span class="children" *ngIf="res.children > 0">üë∂ {{ res.children }} enfants</span>
                            </div>
                        </td>
                        <td class="tour-type">
                            <span class="tour-badge">{{ res.tourType }}</span>
                        </td>
                        <td class="amount">{{ res.totalPrice | number:'1.2-2' }} {{ res.payment?.currency || 'EUR' }}</td>
                        <td>
                            <span class="status-badge" [ngClass]="getStatusClass(res.status)">
                                {{ getStatusLabel(res.status) }}
                            </span>
                        </td>
                        <td class="actions-cell">
                            <button class="btn-action btn-details" (click)="viewDetails(res)" title="Voir les d√©tails">
                                <i class="fas fa-eye"></i>
                                D√©tails
                            </button>
                            <button class="btn-action btn-download" (click)="downloadPDF(res)" title="T√©l√©charger PDF">
                                <i class="fas fa-download"></i>
                            </button>
                        </td>
                    </tr>
                    <tr *ngIf="paginatedReservations.length === 0">
                        <td colspan="7" class="empty-state">
                            <div class="empty-message">
                                <i class="fas fa-inbox"></i>
                                <p>Aucune r√©servation trouv√©e</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-container" *ngIf="filteredReservations.length > 0">
            <div class="pagination-info">
                Affichage de {{ ((currentPage - 1) * itemsPerPage) + 1 }} 
                √† {{ Math.min(currentPage * itemsPerPage, filteredReservations.length) }} 
                sur {{ filteredReservations.length }} r√©servations
            </div>
            
            <div class="pagination-controls">
                <button class="pagination-btn" 
                        [disabled]="currentPage === 1" 
                        (click)="previousPage()"
                        title="Page pr√©c√©dente">
                    <i class="fas fa-chevron-left"></i>
                </button>

                <button *ngFor="let page of getPageNumbers()" 
                        class="pagination-btn page-number" 
                        [class.active]="page === currentPage"
                        [disabled]="page === -1"
                        (click)="page !== -1 && goToPage(page)">
                    <span *ngIf="page === -1">...</span>
                    <span *ngIf="page !== -1">{{ page }}</span>
                </button>

                <button class="pagination-btn" 
                        [disabled]="currentPage === totalPages" 
                        (click)="nextPage()"
                        title="Page suivante">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal-backdrop" *ngIf="selectedReservation" (click)="closeDetails()">
        <div class="modal-content glass-panel" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>üìã D√©tails de la R√©servation</h2>
                <button class="close-btn" (click)="closeDetails()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Client Information -->
                <div class="section">
                    <h3>üë§ Informations Client</h3>
                    <div class="detail-row">
                        <strong>Nom:</strong>
                        <span>{{ selectedReservation.contactInfo.firstName }} {{ selectedReservation.contactInfo.lastName }}</span>
                    </div>
                    <div class="detail-row">
                        <strong>Email:</strong>
                        <span>{{ selectedReservation.contactInfo.email }}</span>
                    </div>
                    <div class="detail-row">
                        <strong>T√©l√©phone:</strong>
                        <span>{{ selectedReservation.contactInfo.phone }}</span>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Tour Information -->
                <div class="section">
                    <h3>üó∫Ô∏è Informations du Tour</h3>
                    <div class="detail-row">
                        <strong>Type de Tour:</strong>
                        <span class="tour-badge">{{ selectedReservation.tourType }}</span>
                    </div>
                    <div class="detail-row">
                        <strong>Date de d√©but:</strong>
                        <span>{{ selectedReservation.checkInDate | date:'fullDate' }}</span>
                    </div>
                    <div class="detail-row">
                        <strong>Date de fin:</strong>
                        <span>{{ selectedReservation.checkOutDate | date:'fullDate' }}</span>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Participants -->
                <div class="section">
                    <h3>üë• Participants</h3>
                    <div class="detail-row">
                        <strong>Adultes:</strong>
                        <span>{{ selectedReservation.adults }} personnes</span>
                    </div>
                    <div class="detail-row">
                        <strong>Enfants:</strong>
                        <span>{{ selectedReservation.children }} personnes</span>
                    </div>
                    <div class="detail-row highlight">
                        <strong>Total:</strong>
                        <span>{{ selectedReservation.numberOfPeople }} personnes</span>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Extras -->
                <div class="section" *ngIf="selectedReservation.extras && selectedReservation.extras.length > 0">
                    <h3>‚ûï Extras</h3>
                    <div class="extras-list">
                        <div class="extra-item" *ngFor="let extra of selectedReservation.extras">
                            <div class="extra-info">
                                <strong>{{ extra.name }}</strong>
                                <span class="extra-details">{{ extra.quantity }} x {{ extra.unitPrice | number:'1.2-2' }} {{ selectedReservation.payment?.currency || 'EUR' }}</span>
                            </div>
                            <span class="extra-price">{{ extra.totalPrice | number:'1.2-2' }} {{ selectedReservation.payment?.currency || 'EUR' }}</span>
                        </div>
                    </div>
                    <div class="divider"></div>
                </div>

                <!-- Payment Information -->
                <div class="section">
                    <h3>üí∞ Informations de Paiement</h3>
                    <div class="detail-row">
                        <strong>Montant total:</strong>
                        <span>{{ selectedReservation.payment?.totalAmount || selectedReservation.totalPrice || 0 | number:'1.2-2' }} ‚Ç¨</span>
                    </div>
                    <div class="detail-row">
                        <strong>Montant pay√©:</strong>
                        <span class="paid-amount">{{ selectedReservation.payment?.paidAmount || 0 | number:'1.2-2' }} ‚Ç¨</span>
                    </div>
                    <div class="detail-row">
                        <strong>Montant restant:</strong>
                        <span class="remaining-amount">{{ ((selectedReservation.payment?.totalAmount || selectedReservation.totalPrice || 0) - (selectedReservation.payment?.paidAmount || 0)) | number:'1.2-2' }} ‚Ç¨</span>
                    </div>
                    <div class="detail-row" *ngIf="selectedReservation.payment?.paymentStatus">
                        <strong>Statut paiement:</strong>
                        <span class="payment-status">{{ selectedReservation.payment.paymentStatus }}</span>
                    </div>
                </div>

                <div class="divider"></div>

                <!-- Reservation Status -->
                <div class="section">
                    <h3>üìä Statut de la R√©servation</h3>
                    <div class="detail-row highlight">
                        <strong>Statut:</strong>
                        <span class="status-badge" [ngClass]="getStatusClass(selectedReservation.status)">
                            {{ getStatusLabel(selectedReservation.status) }}
                        </span>
                    </div>
                    <div class="detail-row">
                        <strong>Cr√©√©e le:</strong>
                        <span>{{ selectedReservation.createdAt | date:'fullDate' }}</span>
                    </div>
                    <div class="detail-row" *ngIf="selectedReservation.rejectionReason">
                        <strong>Raison du rejet:</strong>
                        <span class="rejection-reason">{{ selectedReservation.rejectionReason }}</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-download-modal" (click)="downloadPDF(selectedReservation)">
                    <i class="fas fa-download"></i>
                    T√©l√©charger PDF
                </button>
                <button class="btn-close-modal" (click)="closeDetails()">Fermer</button>
            </div>
        </div>
    </div>
</div>